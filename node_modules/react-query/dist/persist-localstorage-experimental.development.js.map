{"version":3,"file":"persist-localstorage-experimental.development.js","sources":["../node_modules/@babel/runtime/helpers/esm/extends.js","../src/hydration/hydration.ts","../src/persist-localstorage-experimental/index.ts"],"sourcesContent":["export default function _extends() {\n  _extends = Object.assign || function (target) {\n    for (var i = 1; i < arguments.length; i++) {\n      var source = arguments[i];\n\n      for (var key in source) {\n        if (Object.prototype.hasOwnProperty.call(source, key)) {\n          target[key] = source[key];\n        }\n      }\n    }\n\n    return target;\n  };\n\n  return _extends.apply(this, arguments);\n}","import type { QueryClient } from '../core/queryClient'\nimport type { Query, QueryState } from '../core/query'\nimport type {\n  MutationKey,\n  MutationOptions,\n  QueryKey,\n  QueryOptions,\n} from '../core/types'\nimport type { Mutation, MutationState } from '../core/mutation'\n\n// TYPES\n\nexport interface DehydrateOptions {\n  dehydrateMutations?: boolean\n  dehydrateQueries?: boolean\n  shouldDehydrateMutation?: ShouldDehydrateMutationFunction\n  shouldDehydrateQuery?: ShouldDehydrateQueryFunction\n}\n\nexport interface HydrateOptions {\n  defaultOptions?: {\n    queries?: QueryOptions\n    mutations?: MutationOptions\n  }\n}\n\ninterface DehydratedMutation {\n  mutationKey?: MutationKey\n  state: MutationState\n}\n\ninterface DehydratedQuery {\n  queryHash: string\n  queryKey: QueryKey\n  state: QueryState\n}\n\nexport interface DehydratedState {\n  mutations: DehydratedMutation[]\n  queries: DehydratedQuery[]\n}\n\nexport type ShouldDehydrateQueryFunction = (query: Query) => boolean\n\nexport type ShouldDehydrateMutationFunction = (mutation: Mutation) => boolean\n\n// FUNCTIONS\n\nfunction dehydrateMutation(mutation: Mutation): DehydratedMutation {\n  return {\n    mutationKey: mutation.options.mutationKey,\n    state: mutation.state,\n  }\n}\n\n// Most config is not dehydrated but instead meant to configure again when\n// consuming the de/rehydrated data, typically with useQuery on the client.\n// Sometimes it might make sense to prefetch data on the server and include\n// in the html-payload, but not consume it on the initial render.\nfunction dehydrateQuery(query: Query): DehydratedQuery {\n  return {\n    state: query.state,\n    queryKey: query.queryKey,\n    queryHash: query.queryHash,\n  }\n}\n\nfunction defaultShouldDehydrateMutation(mutation: Mutation) {\n  return mutation.state.isPaused\n}\n\nfunction defaultShouldDehydrateQuery(query: Query) {\n  return query.state.status === 'success'\n}\n\nexport function dehydrate(\n  client: QueryClient,\n  options?: DehydrateOptions\n): DehydratedState {\n  options = options || {}\n\n  const mutations: DehydratedMutation[] = []\n  const queries: DehydratedQuery[] = []\n\n  if (options?.dehydrateMutations !== false) {\n    const shouldDehydrateMutation =\n      options.shouldDehydrateMutation || defaultShouldDehydrateMutation\n\n    client\n      .getMutationCache()\n      .getAll()\n      .forEach(mutation => {\n        if (shouldDehydrateMutation(mutation)) {\n          mutations.push(dehydrateMutation(mutation))\n        }\n      })\n  }\n\n  if (options?.dehydrateQueries !== false) {\n    const shouldDehydrateQuery =\n      options.shouldDehydrateQuery || defaultShouldDehydrateQuery\n\n    client\n      .getQueryCache()\n      .getAll()\n      .forEach(query => {\n        if (shouldDehydrateQuery(query)) {\n          queries.push(dehydrateQuery(query))\n        }\n      })\n  }\n\n  return { mutations, queries }\n}\n\nexport function hydrate(\n  client: QueryClient,\n  dehydratedState: unknown,\n  options?: HydrateOptions\n): void {\n  if (typeof dehydratedState !== 'object' || dehydratedState === null) {\n    return\n  }\n\n  const mutationCache = client.getMutationCache()\n  const queryCache = client.getQueryCache()\n\n  const mutations = (dehydratedState as DehydratedState).mutations || []\n  const queries = (dehydratedState as DehydratedState).queries || []\n\n  mutations.forEach(dehydratedMutation => {\n    mutationCache.build(\n      client,\n      {\n        ...options?.defaultOptions?.mutations,\n        mutationKey: dehydratedMutation.mutationKey,\n      },\n      dehydratedMutation.state\n    )\n  })\n\n  queries.forEach(dehydratedQuery => {\n    const query = queryCache.get(dehydratedQuery.queryHash)\n\n    // Do not hydrate if an existing query exists with newer data\n    if (query) {\n      if (query.state.dataUpdatedAt < dehydratedQuery.state.dataUpdatedAt) {\n        query.setState(dehydratedQuery.state)\n      }\n      return\n    }\n\n    // Restore query\n    queryCache.build(\n      client,\n      {\n        ...options?.defaultOptions?.queries,\n        queryKey: dehydratedQuery.queryKey,\n        queryHash: dehydratedQuery.queryHash,\n      },\n      dehydratedQuery.state\n    )\n  })\n}\n","import { QueryClient } from '../core'\nimport { dehydrate, hydrate } from '../hydration'\n\ninterface LocalStorageCache {\n  timestamp: number\n  buster: string\n  cacheState: any\n}\n\ninterface Options {\n  /** The key to use when storing the cache to localstorage */\n  localStorageKey?: string\n  /** To avoid localstorage spamming,\n   * pass a time in ms to throttle saving the cache to disk */\n  throttleTime?: number\n  /** The max-allowed age of the cache.\n   * If a persisted cache is found that is older than this\n   * time, it will be discarded */\n  maxAge?: number\n  /** A unique string that can be used to forcefully\n   * invalidate existing caches if they do not share the same buster string */\n  buster?: string\n}\n\nexport function persistWithLocalStorage(\n  queryClient: QueryClient,\n  {\n    localStorageKey = `REACT_QUERY_OFFLINE_CACHE`,\n    throttleTime = 1000,\n    maxAge = 1000 * 60 * 60 * 24,\n    buster = '',\n  }: Options = {}\n) {\n  if (typeof window !== 'undefined') {\n    // Subscribe to changes\n    const saveCache = throttle(() => {\n      const storageCache: LocalStorageCache = {\n        buster,\n        timestamp: Date.now(),\n        cacheState: dehydrate(queryClient),\n      }\n\n      localStorage.setItem(localStorageKey, JSON.stringify(storageCache))\n    }, throttleTime)\n\n    queryClient.getQueryCache().subscribe(saveCache)\n\n    // Attempt restore\n    const cacheStorage = localStorage.getItem(localStorageKey)\n\n    if (!cacheStorage) {\n      return\n    }\n\n    const cache: LocalStorageCache = JSON.parse(cacheStorage)\n\n    if (cache.timestamp) {\n      const expired = Date.now() - cache.timestamp > maxAge\n      const busted = cache.buster !== buster\n      if (expired || busted) {\n        localStorage.removeItem(localStorageKey)\n      } else {\n        hydrate(queryClient, cache.cacheState)\n      }\n    } else {\n      localStorage.removeItem(localStorageKey)\n    }\n  }\n}\n\nfunction throttle(func: (...args: any[]) => any, wait = 100) {\n  let timer: number | null = null\n\n  return function (...args: any[]) {\n    if (timer === null) {\n      timer = setTimeout(() => {\n        func(...args)\n        timer = null\n      }, wait)\n    }\n  }\n}\n"],"names":["_extends","Object","assign","target","i","arguments","length","source","key","prototype","hasOwnProperty","call","apply","dehydrateMutation","mutation","mutationKey","options","state","dehydrateQuery","query","queryKey","queryHash","defaultShouldDehydrateMutation","isPaused","defaultShouldDehydrateQuery","status","dehydrate","client","mutations","queries","dehydrateMutations","shouldDehydrateMutation","getMutationCache","getAll","forEach","push","dehydrateQueries","shouldDehydrateQuery","getQueryCache","hydrate","dehydratedState","mutationCache","queryCache","dehydratedMutation","build","defaultOptions","dehydratedQuery","get","dataUpdatedAt","setState","persistWithLocalStorage","queryClient","localStorageKey","throttleTime","maxAge","buster","window","saveCache","throttle","storageCache","timestamp","Date","now","cacheState","localStorage","setItem","JSON","stringify","subscribe","cacheStorage","getItem","cache","parse","expired","busted","removeItem","func","wait","timer","args","setTimeout"],"mappings":"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"}